version: '2'
services:

  job:
    image: skale/hmt-escrow:skale-0.9.2
    build: .
    environment:
      - HMT_ETH_SERVER=https://staging-v2.skalenodes.com/v1/stocky-pleione
      - HET_WAIT_FOR_SERVER=http://het:8000
      - GAS_LIMIT=6700000
      - IPFS_HOST=ipfs
      - IPFS_PORT=5001
      - ETH_HOST=ganache
      - ETH_PORT=8545
      - ESCROW_BUCKETNAME=escrow-results
      - ESCROW_AWS_ACCESS_KEY_ID=minio
      - ESCROW_AWS_SECRET_ACCESS_KEY=minio123
      - ESCROW_ENDPOINT_URL=http://minio:9000
      - ESCROW_AWS_DEFAULT_REGION=us-west-2
      - DEBUG=true
      - USE_ESCROW_S3_STORAGE=True
      - PRIV_KEY=3e4da933deecae77aed4618e0848145365486c65503efc76017a540275666ca6
    depends_on:
      - minio
      - ganache
    links:
      - ganache
      - ipfs
      - kvstore
    volumes:
      - eth_kvstore_addr:/deployed-kvstore
      - ./minio:/data
      - .:/work
    command: sh -c "curl --retry 10 --retry-connrefused --retry-max-time 10 https://staging-v2.skalenodes.com/v1/stocky-pleione; cd /work && npm install && npm run compile;npm run test;bash ./bin/wait_then_run"

  ganache:
    image: trufflesuite/ganache-cli:latest
    command: node ./build/cli.node.js --noVMErrorsOnRPCResponse -m goat --hostname 0.0.0.0 --unlock 0x1413862c2b7054cdbfdc181b83962cb0fc11fd92 -g 1000
    ports:
      - 8545:8545

  kvstore:
    build: https://github.com/AzizBardi/eth-kvstore.git
    links:
      - ganache
    environment:
      - ETH_HOST=ganache
      - ETH_PORT=8545
      - ADDRESS_OUTPUT_FILENAME=/deployed/ethkvstore.address.json
      - MNEMONIC=3e4da933deecae77aed4618e0848145365486c65503efc76017a540275666ca6      
    volumes:
      - eth_kvstore_addr:/deployed

  ipfs:
    image: ipfs/go-ipfs:v0.4.22
    command: daemon --offline
    ports:
      - 5001:5001

  minio:
    image: minio/minio:RELEASE.2020-04-28T23-56-56Z
    ports:
      - "9000:9000"
    expose:
      - "9000"
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    entrypoint: sh -c 'minio server /data/'
    volumes:
      - ./minio:/data

volumes:
  eth_kvstore_addr:
